{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}

<div class="container-fluid px-3 py-4">

  <!-- HEADER -->
  <div class="text-center mb-4">
    <h1 class="fw-bold mb-2" style="color: #fff;">üìä Reportes de Ventas</h1>
    <div style="width: 100px; height: 3px; background: var(--rayo-red, #b51f24); margin: 0 auto;"></div>
    <p class="mt-2" style="color: #999;">Estad√≠sticas detalladas del rendimiento comercial</p>
  </div>

  <!-- FILTROS -->
  <div class="card shadow-card mb-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">

        <div class="col-md-4 col-lg-3">
          <label class="form-label fw-bold" style="color:#e9e9e9;">Desde</label>
          <input type="date" name="start" value="{{ start }}" class="form-control bg-dark text-light border-secondary">
        </div>

        <div class="col-md-4 col-lg-3">
          <label class="form-label fw-bold" style="color:#e9e9e9;">Hasta</label>
          <input type="date" name="end" value="{{ end }}" class="form-control bg-dark text-light border-secondary">
        </div>

        <div class="col-md-4 col-lg-6 d-flex gap-2">
          <button class="btn btn-danger flex-grow-1" style="background: var(--rayo-red); border:none;">
            <i class="bi bi-filter me-1"></i> Aplicar filtros
          </button>

          <a href="{% url 'reports:export_pdf' %}?start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}"
            class="btn btn-outline-light" target="_blank"
            style="border-color: var(--rayo-red); color: var(--rayo-red);">
            <i class="bi bi-file-earmark-pdf me-1"></i> PDF
          </a>
        </div>

      </form>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-4">
      <div class="card kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <p class="kpi-title">Ventas Totales</p>
              <h3 class="kpi-value">${{ ventas_total|floatformat:2 }}</h3>
            </div>
            <i class="bi bi-cash-stack kpi-icon"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <p class="kpi-title">Pedidos</p>
              <h3 class="kpi-value">{{ cantidad_pedidos }}</h3>
            </div>
            <i class="bi bi-box-seam kpi-icon"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-4">
      <div class="card kpi-card">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <p class="kpi-title">Ganancia Estimada</p>
              <h3 class="kpi-value">${{ ganancia_total|floatformat:2 }}</h3>
            </div>
            <i class="bi bi-graph-up kpi-icon"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- VENTAS POR SEMANA -->
  <div class="card shadow-card mb-4">
    <div class="card-header table-header">
      <h5 class="mb-0 fw-bold"><i class="bi bi-calendar-week me-2"></i>Ventas por semana</h5>
    </div>

    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Semana</th>
            <th>Total</th>
          </tr>
        </thead>

        <tbody>
          {% for w in weeks %}
          <tr>
            <td>{{ w.start }} ‚Üí {{ w.end }}</td>
            <td class="text-danger fw-bold">${{ w.total|floatformat:2 }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="2" class="text-center text-muted py-3">No hay datos en este per√≠odo</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- PRODUCTOS M√ÅS VENDIDOS -->
  <div class="card shadow-card mb-4">
    <div class="card-header table-header">
      <h5 class="mb-0 fw-bold"><i class="bi bi-trophy me-2"></i>Productos m√°s vendidos</h5>
    </div>

    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Producto</th>
            <th class="text-center">Cantidad</th>
          </tr>
        </thead>

        <tbody>
          {% for row in top_products_page %}
          <tr>
            <td><span class="badge bg-danger">{{ row.producto.pk }}</span></td>
            <td>{{ row.producto.nombre }}</td>
            <td class="text-center text-danger fw-bold">{{ row.cantidad }}</td>
          </tr>

          {% empty %}
          <tr>
            <td colspan="3" class="text-center text-muted py-3">No hay productos vendidos</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- PAGINACI√ìN -->
    {% if top_products_page.has_other_pages %}
    <div class="card-footer text-center" style="background: #0f0f0f;">
      <div class="pagination justify-content-center">

        {% if top_products_page.has_previous %}
        <a href="?page={{ top_products_page.previous_page_number }}&start={{ start }}&end={{ end }}" class="page-link">‚Üê
          Anterior</a>
        {% endif %}

        <span class="page-link disabled bg-dark text-light border-secondary">
          P√°gina {{ top_products_page.number }} de {{ top_products_page.paginator.num_pages }}
        </span>

        {% if top_products_page.has_next %}
        <a href="?page={{ top_products_page.next_page_number }}&start={{ start }}&end={{ end }}"
          class="page-link">Siguiente ‚Üí</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

</div>

<style>
  /* --- ESTILO RAYO --- */

  body {
    background: #0f0f0f !important;
  }

  .shadow-card {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 0.5rem;
    transition: 0.25s ease;
  }

  .shadow-card:hover {
    border-color: var(--rayo-red, #b51f24);
    box-shadow: 0 5px 25px rgba(181, 31, 36, 0.25);
    transform: translateY(-2px);
  }

  .table-header {
    background: #000;
    color: var(--rayo-red, #b51f24);
    border-bottom: 2px solid var(--rayo-red);
    padding: 1rem;
  }

  .kpi-card {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: .5rem;
    padding: 1rem;
    transition: .25s;
  }

  .kpi-card:hover {
    border-color: var(--rayo-red);
    box-shadow: 0 6px 20px rgba(181, 31, 36, 0.3);
    transform: translateY(-3px);
  }

  .kpi-title {
    color: #999;
    text-transform: uppercase;
    font-size: .85rem;
    font-weight: 600;
  }

  .kpi-value {
    color: var(--rayo-red);
    font-weight: 700;
    font-size: 1.9rem;
  }

  .kpi-icon {
    font-size: 2.5rem;
    color: var(--rayo-red);
  }

  .page-link {
    background: #1a1a1a;
    color: #e9e9e9;
    border: 1px solid #2a2a2a;
    margin: 0 4px;
  }

  .page-link:hover {
    background: var(--rayo-red);
    border-color: var(--rayo-red);
    color: #fff;
  }
</style>

{% endblock %}